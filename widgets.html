<!DOCTYPE html><html lang="en"><head><title>widgets</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="widgets"><meta name="groc-project-path" content="ckeditor/widgets.py"><meta name="groc-github-url" content="https://github.com/concentricsky/django-sky-ckeditor"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/concentricsky/django-sky-ckeditor/blob/master/ckeditor/widgets.py">ckeditor/widgets.py</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kn">import</span> <span class="nn">re</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.admin</span> <span class="kn">import</span> <span class="n">widgets</span> <span class="k">as</span> <span class="n">admin_widgets</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.conf.urls.defaults</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>


<span class="n">CKEDITOR_CONFIGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">CKEDITOR_CONFIGS</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="n">FILEBROWSER_PRESENT</span> <span class="o">=</span> <span class="s">&#39;filebrowser&#39;</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;INSTALLED_APPS&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">CKEDITOR_EMBED_CONTENT</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;CKEDITOR_EMBED_CONTENT&#39;</span><span class="p">,</span> <span class="p">[])</span>

<span class="n">MEDIA</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;CKEDITOR_MEDIA_URL&#39;</span><span class="p">,</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">STATIC_URL</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CKEditor</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;attrs&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;django-ckeditor&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;attrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckeditor_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;ckeditor_config&#39;</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CKEditor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CKEditor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">content_embed_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">content_embed_urls</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">model_string</span> <span class="ow">in</span> <span class="n">CKEDITOR_EMBED_CONTENT</span><span class="p">:</span>

            <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">current_contenttype</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
            <span class="n">model_label</span> <span class="o">=</span> <span class="n">current_contenttype</span><span class="o">.</span><span class="n">model_class</span><span class="p">()</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span>
            <span class="n">contenttype_id</span> <span class="o">=</span> <span class="n">current_contenttype</span><span class="o">.</span><span class="n">id</span>
            <span class="n">model_url</span> <span class="o">=</span> <span class="s">&#39;../../../</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/?t=id&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">content_embed_options</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">model_label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">contenttype_id</span><span class="p">)]]</span>
            <span class="n">content_embed_urls</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">contenttype_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">model_url</span>

        <span class="n">image_embed_url</span> <span class="o">=</span> <span class="s">&#39;../../../</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/?t=id&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span> <span class="s">&#39;imageupload&#39;</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;config&#39;</span><span class="p">:</span> <span class="n">CKEDITOR_CONFIGS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ckeditor_config</span><span class="p">],</span>
            <span class="s">&#39;filebrowser&#39;</span><span class="p">:</span> <span class="n">FILEBROWSER_PRESENT</span><span class="p">,</span>
            <span class="s">&#39;content_embed_options&#39;</span><span class="p">:</span> <span class="n">content_embed_options</span><span class="p">,</span>
            <span class="s">&#39;content_embed_urls&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content_embed_urls</span><span class="p">),</span>
            <span class="s">&#39;image_embed_url&#39;</span><span class="p">:</span> <span class="n">image_embed_url</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This "regex" should match the ID attribute of this field.
The reason we use a regex is so we can handle inlines, which will have
IDs like: id_subsection-6-description</p></div></div><div class="code"><div class="wrapper">            <span class="s">&#39;regex&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;__prefix__&#39;</span><span class="p">,</span> <span class="s">r&#39;\d+&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">rendered</span> <span class="o">+</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">render_to_string</span><span class="p">(</span> <span class="s">&#39;ckeditor/ckeditor_script.html&#39;</span><span class="p">,</span> <span class="n">context</span> <span class="p">))</span> 

    <span class="k">def</span> <span class="nf">value_from_datadict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;(.*?)(\s*&lt;br\s*/?&gt;\s*)*\Z&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Media</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MEDIA</span> <span class="o">+</span> <span class="s">&#39;/ckeditor/ckeditor/ckeditor.js&#39;</span><span class="p">,</span>
            <span class="n">MEDIA</span> <span class="o">+</span> <span class="s">&#39;/ckeditor/init.js&#39;</span><span class="p">,</span>
            <span class="n">MEDIA</span> <span class="o">+</span> <span class="s">&#39;/client_admin/js/genericadmin.js&#39;</span><span class="p">,</span>
            <span class="n">MEDIA</span> <span class="o">+</span> <span class="s">&#39;/ckeditor/genericadmin.js&#39;</span><span class="p">,</span>
        <span class="p">)</span>



<span class="k">class</span> <span class="nc">AdminCKEditor</span><span class="p">(</span><span class="n">admin_widgets</span><span class="o">.</span><span class="n">AdminTextareaWidget</span><span class="p">,</span> <span class="n">CKEditor</span><span class="p">):</span>
    <span class="k">pass</span></div></div></div></div></body></html>